name: Agent Tests CI

# å¿«é€Ÿçš„ Agent åŠŸèƒ½æµ‹è¯•æµç¨‹
# ä¸“æ³¨äºéªŒè¯ Agent æ ¸å¿ƒåŠŸèƒ½ï¼Œé€‚åˆå¿«é€Ÿåé¦ˆ
# 
# ç‰¹ç‚¹ï¼š
# - å•ç‰ˆæœ¬ Python (3.10)
# - å¿«é€Ÿæµ‹è¯•ï¼ˆçƒŸé›¾æµ‹è¯• + å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
# - æ’é™¤ MCP æµ‹è¯•ï¼ˆéœ€è¦å•ç‹¬çš„ MCP æœåŠ¡ï¼‰
# 
# å¦‚éœ€å®Œæ•´çš„ CI/CD æµç¨‹ï¼ˆå¤šç‰ˆæœ¬æµ‹è¯•ã€å®‰å…¨æ‰«æç­‰ï¼‰ï¼Œè¯·æŸ¥çœ‹ ci.yml

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: "3.10"
  MOCK_MODE: "true"

jobs:
  # çƒŸé›¾æµ‹è¯• - å¿«é€ŸéªŒè¯
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: è¿è¡ŒçƒŸé›¾æµ‹è¯•
      env:
        MOCK_MODE: "true"
      run: |
        python tests/smoke_test.py

  # å•å…ƒæµ‹è¯• - AgentåŠŸèƒ½
  unit-tests:
    name: Unit Tests (Agent Functions)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: smoke-test
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
    
    - name: è¿è¡Œé…ç½®æµ‹è¯•
      env:
        MOCK_MODE: "true"
      run: |
        pytest tests/test_config.py -v -m "not mcp"
    
    - name: è¿è¡Œå·¥å…·æµ‹è¯•
      env:
        MOCK_MODE: "true"
      run: |
        pytest tests/test_tools.py -v -m "not mcp"
    
    - name: è¿è¡Œå·¥å…·æ¨¡å—æµ‹è¯•
      env:
        MOCK_MODE: "true"
      run: |
        pytest tests/test_utils.py -v -m "not mcp and not slow"

  # é›†æˆæµ‹è¯• - Agentå·¥ä½œæµ
  integration-tests:
    name: Integration Tests (Agent Workflows)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: è¿è¡Œç»¼åˆæµ‹è¯•ï¼ˆæ’é™¤MCPï¼‰
      env:
        MOCK_MODE: "true"
      run: |
        python tests/comprehensive_test.py

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä»£ç è´¨é‡å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint
    
    - name: è¿è¡ŒFlake8æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonè¯­æ³•é”™è¯¯å’Œæœªå®šä¹‰çš„åç§°
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # æ£€æŸ¥ä»£ç é£æ ¼ï¼ˆè­¦å‘Šçº§åˆ«ï¼‰
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics \
          --exclude=__pycache__,venv,env,.venv,.git,outputs,logs
    
    - name: æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰
      run: |
        black --check --diff --exclude="/(\.git|\.venv|venv|env|__pycache__|outputs|logs)/" .
      continue-on-error: true  # æ ¼å¼é—®é¢˜ä¸é˜»æ­¢æ„å»º

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [smoke-test, unit-tests, integration-tests, code-quality]
    if: always()
    
    steps:
    - name: æ£€æŸ¥æµ‹è¯•ç»“æœ
      run: |
        echo "=== CI/CD æµ‹è¯•æ€»ç»“ ==="
        echo "âœ… çƒŸé›¾æµ‹è¯•: ${{ needs.smoke-test.result }}"
        echo "âœ… å•å…ƒæµ‹è¯•: ${{ needs.unit-tests.result }}"
        echo "âœ… é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}"
        echo "âœ… ä»£ç è´¨é‡: ${{ needs.code-quality.result }}"
        echo ""
        echo "æ³¨æ„: MCPç›¸å…³æµ‹è¯•å·²è¢«æ’é™¤ï¼ˆéœ€è¦å•ç‹¬çš„MCPæœåŠ¡ï¼‰"
        
        # å¦‚æœæœ‰ä»»ä½•å¿…éœ€çš„æµ‹è¯•å¤±è´¥ï¼Œåˆ™å¤±è´¥
        if [ "${{ needs.smoke-test.result }}" != "success" ] || \
           [ "${{ needs.unit-tests.result }}" != "success" ] || \
           [ "${{ needs.integration-tests.result }}" != "success" ]; then
          echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        
        echo "ğŸ‰ æ‰€æœ‰Agentæµ‹è¯•é€šè¿‡ï¼"

