# CI/CD æŒ‡å—

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [CI/CD æµç¨‹](#cicd-æµç¨‹)
- [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
- [ä»£ç è´¨é‡](#ä»£ç è´¨é‡)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ **GitHub Actions** å®ç°è‡ªåŠ¨åŒ– CI/CD æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š

- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ï¼‰
- âœ… ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆLintingã€æ ¼å¼åŒ–ï¼‰
- âœ… ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
- âœ… å®‰å…¨æ‰«æ
- âœ… å¤šç‰ˆæœ¬ Python æ”¯æŒï¼ˆ3.9-3.12ï¼‰
- âœ… è·¨å¹³å°æµ‹è¯•ï¼ˆUbuntuã€macOSï¼‰

---

## CI/CD æµç¨‹

### å·¥ä½œæµæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Push/PR       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¶è¡Œæ‰§è¡Œ                                â”‚
â”‚  â”œâ”€ ä»£ç è´¨é‡æ£€æŸ¥ (Black, Flake8, MyPy)  â”‚
â”‚  â”œâ”€ å•å…ƒæµ‹è¯• (Python 3.9-3.12)          â”‚
â”‚  â”œâ”€ å®‰å…¨æ‰«æ (Bandit, Safety)           â”‚
â”‚  â””â”€ æ–‡æ¡£æ£€æŸ¥                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é›†æˆæµ‹è¯•        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å»ºæ£€æŸ¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥ç»“æœ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§¦å‘æ¡ä»¶

CI/CD æµç¨‹åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è‡ªåŠ¨è§¦å‘ï¼š

- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- åˆ›å»º Pull Request
- æ‰‹åŠ¨è§¦å‘ï¼ˆ`workflow_dispatch`ï¼‰

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çƒŸé›¾æµ‹è¯• (Smoke Tests)              â”‚  â† å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½
â”‚  æ—¶é—´: ~10ç§’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•å…ƒæµ‹è¯• (Unit Tests)               â”‚  â† æµ‹è¯•ç‹¬ç«‹æ¨¡å—
â”‚  æ—¶é—´: ~30ç§’                         â”‚
â”‚  è¦†ç›–ç‡: >80%                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é›†æˆæµ‹è¯• (Integration Tests)        â”‚  â† æµ‹è¯•æ¨¡å—åä½œ
â”‚  æ—¶é—´: ~1åˆ†é’Ÿ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç«¯åˆ°ç«¯æµ‹è¯• (E2E Tests)              â”‚  â† æµ‹è¯•å®Œæ•´æµç¨‹
â”‚  æ—¶é—´: ~2åˆ†é’Ÿ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµ‹è¯•åˆ†ç±»

ä½¿ç”¨ pytest markers ç»„ç»‡æµ‹è¯•ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# åªè¿è¡Œå•å…ƒæµ‹è¯•
pytest -m unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
pytest -m integration

# è¿è¡ŒçƒŸé›¾æµ‹è¯•
pytest -m smoke

# è·³è¿‡æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"

# è¿è¡Œéœ€è¦ API çš„æµ‹è¯•
pytest -m api
```

### æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | æè¿° | è¿è¡Œæ—¶é—´ |
|------|------|---------|
| `tests/smoke_test.py` | å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½ | ~10ç§’ |
| `tests/test_config.py` | é…ç½®æ¨¡å—å•å…ƒæµ‹è¯• | ~5ç§’ |
| `tests/test_utils.py` | å·¥å…·æ¨¡å—å•å…ƒæµ‹è¯• | ~15ç§’ |
| `tests/test_tools.py` | å·¥å…·å‡½æ•°å•å…ƒæµ‹è¯• | ~20ç§’ |
| `tests/comprehensive_test.py` | ç»¼åˆæµ‹è¯•å¥—ä»¶ | ~60ç§’ |

---

## ä»£ç è´¨é‡

### è‡ªåŠ¨åŒ–æ£€æŸ¥

1. **ä»£ç æ ¼å¼åŒ– (Black)**
   ```bash
   black --check --diff .
   ```

2. **Import æ’åº (isort)**
   ```bash
   isort --check-only --diff .
   ```

3. **ä»£ç é£æ ¼ (Flake8)**
   ```bash
   flake8 . --max-line-length=100
   ```

4. **ç±»å‹æ£€æŸ¥ (MyPy)**
   ```bash
   mypy . --ignore-missing-imports
   ```

5. **å®‰å…¨æ‰«æ (Bandit)**
   ```bash
   bandit -r .
   ```

### Pre-commit Hooks

å®‰è£… pre-commit hooks ä»¥åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ï¼š

```bash
# å®‰è£… pre-commit
pip install pre-commit

# å®‰è£… hooks
pre-commit install

# æ‰‹åŠ¨è¿è¡Œæ‰€æœ‰æ£€æŸ¥
pre-commit run --all-files
```

é…ç½®æ–‡ä»¶ï¼š`.pre-commit-config.yaml`

---

## å¿«é€Ÿå¼€å§‹

### æœ¬åœ°å¼€å‘

#### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt

# å®‰è£…å¼€å‘ä¾èµ–
pip install pytest pytest-cov pytest-asyncio pytest-mock black flake8 mypy pre-commit
```

#### 2. è¿è¡Œæµ‹è¯•

```bash
# å¿«é€ŸéªŒè¯ï¼ˆçƒŸé›¾æµ‹è¯•ï¼‰
python tests/smoke_test.py

# è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
pytest tests/ -v

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/ --cov=. --cov-report=html
open htmlcov/index.html  # æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_config.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/test_config.py::TestConfig -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/test_config.py::TestConfig::test_config_import -v
```

#### 3. ä»£ç è´¨é‡æ£€æŸ¥

```bash
# æ ¼å¼åŒ–ä»£ç 
black .

# æ’åº imports
isort .

# æ£€æŸ¥ä»£ç é£æ ¼
flake8 .

# ç±»å‹æ£€æŸ¥
mypy .

# å®‰å…¨æ‰«æ
bandit -r .
```

### CI/CD é…ç½®

#### GitHub Actions

å·¥ä½œæµæ–‡ä»¶ï¼š`.github/workflows/ci.yml`

**å…³é”®ç‰¹æ€§ï¼š**

- âœ… å¤šç‰ˆæœ¬ Python æ”¯æŒï¼ˆ3.9, 3.10, 3.11, 3.12ï¼‰
- âœ… è·¨å¹³å°æµ‹è¯•ï¼ˆUbuntu, macOSï¼‰
- âœ… å¹¶è¡Œæ‰§è¡Œï¼Œæå‡é€Ÿåº¦
- âœ… è‡ªåŠ¨ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
- âœ… ä¸Šä¼ åˆ° Codecov

**æŸ¥çœ‹ CI çŠ¶æ€ï¼š**

åœ¨ GitHub ä»“åº“é¡µé¢æŸ¥çœ‹ Actions æ ‡ç­¾é¡µã€‚

---

## é…ç½®è¯´æ˜

### pytest é…ç½®

æ–‡ä»¶ï¼š`pytest.ini` å’Œ `pyproject.toml`

**å…³é”®é…ç½®ï¼š**

```ini
[pytest]
# æµ‹è¯•ç›®å½•
testpaths = tests

# å¹¶è¡Œè¿è¡Œ
addopts = -n auto

# è¦†ç›–ç‡
--cov=. --cov-report=html
```

### è¦†ç›–ç‡é…ç½®

æ–‡ä»¶ï¼š`.coveragerc` å’Œ `pyproject.toml`

**å…³é”®é…ç½®ï¼š**

```ini
[coverage:run]
source = .
omit = */tests/*, */venv/*

[coverage:report]
exclude_lines = pragma: no cover
```

### Pre-commit é…ç½®

æ–‡ä»¶ï¼š`.pre-commit-config.yaml`

**åŒ…å«çš„ hooksï¼š**

- âœ… Blackï¼ˆä»£ç æ ¼å¼åŒ–ï¼‰
- âœ… isortï¼ˆimport æ’åºï¼‰
- âœ… Flake8ï¼ˆä»£ç é£æ ¼ï¼‰
- âœ… MyPyï¼ˆç±»å‹æ£€æŸ¥ï¼‰
- âœ… Banditï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
- âœ… Trailing whitespace æ£€æŸ¥
- âœ… YAML/JSON éªŒè¯

---

## æœ€ä½³å®è·µ

### 1. ç¼–å†™æµ‹è¯•

#### æµ‹è¯•å‘½å

```python
# âœ… å¥½çš„å‘½å
def test_config_loading_from_env():
    pass

def test_draft_manager_saves_and_loads_correctly():
    pass

# âŒ ä¸å¥½çš„å‘½å
def test1():
    pass

def test_stuff():
    pass
```

#### ä½¿ç”¨ Fixtures

```python
import pytest

@pytest.fixture
def sample_content():
    """å¯å¤ç”¨çš„æµ‹è¯•æ•°æ®"""
    return {
        'title': 'æµ‹è¯•æ ‡é¢˜',
        'content': 'æµ‹è¯•å†…å®¹'
    }

def test_content_creation(sample_content):
    # ä½¿ç”¨ fixture
    assert sample_content['title'] == 'æµ‹è¯•æ ‡é¢˜'
```

#### ä½¿ç”¨æ ‡è®°

```python
import pytest

@pytest.mark.unit
def test_simple_function():
    pass

@pytest.mark.integration
def test_module_interaction():
    pass

@pytest.mark.slow
def test_long_running_operation():
    pass
```

### 2. Mock å¤–éƒ¨ä¾èµ–

```python
# è®¾ç½® Mock æ¨¡å¼
import os
os.environ['MOCK_MODE'] = 'true'

# åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ Mock
def test_api_call():
    from utils.mock_data import MockDataGenerator
    
    # ä½¿ç”¨ Mock æ•°æ®è€Œä¸æ˜¯çœŸå® API
    result = MockDataGenerator.mock_xiaohongshu_search("æµ‹è¯•", limit=3)
    assert 'notes' in result
```

### 3. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **æœ€ä½è¦æ±‚**: 60%
- **æ¨èç›®æ ‡**: 80%
- **ç†æƒ³ç›®æ ‡**: 90%+

**æŸ¥çœ‹è¦†ç›–ç‡ï¼š**

```bash
pytest --cov=. --cov-report=term-missing
```

### 4. æŒç»­é›†æˆå»ºè®®

#### æäº¤å‰æ£€æŸ¥

```bash
# è¿è¡Œå®Œæ•´æ£€æŸ¥ï¼ˆæ¨èï¼‰
./scripts/pre-push-check.sh

# æˆ–æ‰‹åŠ¨è¿è¡Œ
black .
isort .
flake8 .
pytest tests/
```

#### Pull Request è§„èŒƒ

- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… ä»£ç è¦†ç›–ç‡ä¸é™ä½
- âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡
- âœ… æ·»åŠ æµ‹è¯•ï¼ˆå¦‚æœæ˜¯æ–°åŠŸèƒ½ï¼‰
- âœ… æ›´æ–°æ–‡æ¡£ï¼ˆå¦‚æœéœ€è¦ï¼‰

### 5. è°ƒè¯•å¤±è´¥çš„æµ‹è¯•

```bash
# è¯¦ç»†è¾“å‡º
pytest tests/test_config.py -v -s

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
pytest --lf

# åœ¨ç¬¬ä¸€ä¸ªå¤±è´¥æ—¶åœæ­¢
pytest -x

# è¿›å…¥è°ƒè¯•æ¨¡å¼
pytest --pdb
```

---

## é™„å½•

### æœ‰ç”¨çš„å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰ pytest markers
pytest --markers

# æ”¶é›†æµ‹è¯•ï¼ˆä¸è¿è¡Œï¼‰
pytest --collect-only

# ç”Ÿæˆ JUnit XML æŠ¥å‘Š
pytest --junit-xml=report.xml

# ç”Ÿæˆ HTML æŠ¥å‘Š
pytest --html=report.html --self-contained-html

# æµ‹è¯•ç‰¹å®šå¹³å°ä»£ç 
pytest -k "test_mac or test_linux"
```

### ç¯å¢ƒå˜é‡

| å˜é‡ | æè¿° | é»˜è®¤å€¼ |
|------|------|--------|
| `MOCK_MODE` | å¯ç”¨ Mock æ¨¡å¼ | `false` |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |
| `DEBUG` | è°ƒè¯•æ¨¡å¼ | `false` |

### ç›¸å…³èµ„æº

- [pytest æ–‡æ¡£](https://docs.pytest.org/)
- [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions)
- [Black æ–‡æ¡£](https://black.readthedocs.io/)
- [Flake8 æ–‡æ¡£](https://flake8.pycqa.org/)
- [MyPy æ–‡æ¡£](https://mypy.readthedocs.io/)

---

## é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æµ‹è¯•å¤±è´¥ï¼šModuleNotFoundError

**åŸå› **ï¼šPython è·¯å¾„é…ç½®é—®é¢˜

**è§£å†³**ï¼š
```bash
# æ–¹æ¡ˆ 1ï¼šä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
cd /path/to/Social-media-agent
pytest tests/

# æ–¹æ¡ˆ 2ï¼šè®¾ç½® PYTHONPATH
export PYTHONPATH=$PWD
pytest tests/
```

#### 2. Coverage æŠ¥å‘Šä¸å‡†ç¡®

**åŸå› **ï¼šæœªè¦†ç›–æ‰€æœ‰æ¨¡å—

**è§£å†³**ï¼š
```bash
# ç¡®ä¿ source é…ç½®æ­£ç¡®
pytest --cov=. --cov-report=html
```

#### 3. Pre-commit hooks å¤ªæ…¢

**åŸå› **ï¼šæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶

**è§£å†³**ï¼š
```bash
# åªæ£€æŸ¥æš‚å­˜çš„æ–‡ä»¶
pre-commit run

# è·³è¿‡ç‰¹å®š hook
SKIP=mypy git commit -m "message"
```

---

**ç¥æµ‹è¯•æ„‰å¿«ï¼** ğŸ‰

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥é˜…æ–‡æ¡£æˆ–æäº¤ Issueã€‚

